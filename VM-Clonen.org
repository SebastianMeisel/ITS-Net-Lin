:LaTeX_PROPERTIES:
#+LANGUAGE: de
#+OPTIONS: d:nil todo:nil pri:nil tags:nil
#+OPTIONS: H:4
#+LaTeX_CLASS: orgstandard
#+LaTeX_CMD: xelatex
#+LATEX_HEADER: \usepackage{listings}
:END:

:REVEAL_PROPERTIES:
#+REVEAL_ROOT: https://cdn.jsdelivr.net/npm/reveal.js
#+REVEAL_REVEAL_JS_VERSION: 4
#+REVEAL_THEME: league
#+REVEAL_EXTRA_CSS: ./mystyle.css
#+REVEAL_HLEVEL: 2
#+OPTIONS: timestamp:nil toc:nil num:nil
:END:

#+TITLE: VM Klonen mit HyperV
#+SUBTITLE: ITS-Net-Lin
#+AUTHOR: Sebastian Meisel

* Exportieren der VM
 1) WÃ¤hlen Sie die zu klonende VM (z. B. â€Debian_FISIBâ€) aus.
    - Stellen Sie sicher, dass die VM, die Sie klonen mÃ¶chten, ausgeschaltet ist (Status: â€Ausâ€œ).
 2) Klicken Sie im rechten Bereich unter â€Aktionenâ€ auf â€Exportieren...â€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-01.png]]

 1) Klicken Sie auf â€Durchsuchenâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-02.png]]

  1) Klicken Sie mit der rechten Maustaste in die Adressleiste.
  2) WÃ¤hlen Sie im MenÃ¼ â€Adresse bearbeitenâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-03.png]]

   1) Tragen Sie in der Adressleiste =C:\Users\Benutzername= ein. Ersetzen Sie dabei â€Benutzernameâ€ durch ihren Benutzernamen unter Windows.
      - BestÃ¤tigen Sie mit =[Enter]=.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-04.png]]

  1) klicken Sie auf â€Neuer Ordnerâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-05.png]]

   1) Benennen Sie den neuen Ordner â€HyperVâ€

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-06.png]]


   1) Stellen Sie sicher, dass Sie im Ordner â€HyperVâ€ sind.
   2) Klicken Sie â€Ordner auswÃ¤hlenâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-07.png]]

   1) ÃœberprÃ¼fen Sie, dass als Speicherort â€C:\Users\IhrBenutzername\HyperVâ€ gewÃ¤hlt wurde.
      Kopieren Sie diesen Pfad.
   2) â€Exportierenâ€ Sie die VM.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-08.png]]

   1) Der Fortschritt des Exports wird im Bereich â€šStatusâ€˜ angezeigt.
      Warten Sie, bis der Export abgeschlossen ist und keine Fortschrittsanzeige mehr erscheint.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-09.png]]

   1) WÃ¤hlen Sie rechts unter â€Aktionenâ€ den MenÃ¼punkt â€Virtuellen Computer importierenâ€¦â€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-10.png]]

   1) Ãœberspringen Sie die Vorbemerkungen mit â€Weiterâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-11.png]]

   1) Klicken Sie bei â€Ordner suchenâ€ auf â€Durchsuchenâ€¦â€. 

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-12.png]]

   1) Gehen Sie wieder zum Ordner â€HyperVâ€ in Ihrem Benutzerverzeichnis.
   2) WÃ¤hlen Sie den Ordner, in den die VM exportiert wurde.
   3) BestÃ¤tigen Sie mit â€Ordner auswÃ¤hlenâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-13.png]]

   1) ÃœberprÃ¼fen Sie, dass das korrekte Unterverzeichnis ausgewÃ¤hlt ist.
   2) BestÃ¤tigen Sie mit â€Weiterâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-14.png]]

   Hier sollte nun der Name der Virtuellen Maschine genannt werden.
   1) BestÃ¤tigen Sie mit â€Weiterâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-15.png]]

   1) Unter â€Importtyp auswÃ¤hlenâ€ den 3. Punkt â€Virtuellen Computer kopieren (neue eindeutige ID erstellen)â€.

#+begin_quote
Die anderen Alternativen sind fÃ¼r Backup-Zwecke gedacht. Ohne eindeutige ID kann der Klon nicht neben der Original-VM ausgefÃ¼hrt werden.
#+end_quote

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-16.png]]

Setzen Sie unter â€Ziel auswÃ¤hlenâ€ den Haken bei â€Virtuellen Computer an einem anderen Ort speichernâ€.
   1) 2) 3) FÃ¼gen Sie  den vorher kopierten Pfad =C:\\Users\IhrBenutzername\HyperV= bei allen ein.
   4) BestÃ¤tigen Sie mit â€Weiterâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-17.png]]

   1) FÃ¼gen denselben Pfad unter â€Speicherort auswÃ¤hlenâ€ ein.
   2) BestÃ¤tigen Sie mit â€Weiterâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-18.png]]

   1) BestÃ¤tigen Sie die Zusammenfassung mit â€Fertig stellenâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-19.png]]

   1) Warten Sie bis das Festplatten-Abbild (=vhdx=) kopiert wurde.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-20.png]]

   1) Klicken Sie den Namen des Klons unter â€Virtuelle Computerâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-21.png]]

   1) Benennen Sie die VM z.Â B. in â€Codeâ€ um.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-22.png]]

   1) Gehen Sie rechts unten auf â€Einstellungenâ€.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-23.png]]

   1) Gehen Sie zum Abschnitt â€Arbeitsspeicherâ€.
   2) Begrenzen Sie den maximalen RAM auf ~4096Â MB~.
   3) SchlieÃŸen Sie das Fenster mit â€OKâ€.
   Wiederholen Sie dasselbe fÃ¼r die Original-VM.

#+ATTR_HTML: :width 50%
#+ATTR_LATEX: :width .65\linewidth :placement [!htpb]
#+ATTR_ORG: :width 700
[[file:/home/sebastian/git/ITS-Net-Lin/Bilder/Clone-24.png]]

* Hostnamen anpassen

Starten Sie die VM, melden Sie sich an und starten Sie den Terminal-Emulator.

** =hostnamectl=

Auf modernen Systemen bietet =hostnamectl= die beste MÃ¶glichkeit den Hostnamen anzupassen, unter dem der Rechner (in diesem Fall die VM) erreichbar ist. Es ist wichtig, dass jeder Rechnen einen individuellen Hostnamen hat.

#+BEGIN_SRC bash
hostnamectl
#+END_SRC

#+BEGIN_EXAMPLE
 Static hostname: debian
       Icon name: computer-vm
         Chassis: vm ğŸ–´
      Machine ID: 469b943a1653455f843e711d1a3d6a58
         Boot ID: 0896ffa758d44bce98781b59a659c3f8
  Virtualization: microsoft
Operating System: Debian GNU/Linux 12 (bookworm)  
          Kernel: Linux 6.1.0-28-amd64
    Architecture: x86-64
 Hardware Vendor: Microsoft Corporation
  Hardware Model: Virtual Machine
Firmware Version: Hyper-V UEFI Release v4.1
#+END_EXAMPLE

Um den hostnamen zu Ã¤ndern nutzen Sie den Befehl:

#+BEGIN_SRC bash
sudo hostnamectl hostname --static clone
#+END_SRC

Auf Legacy-Systemen (die hostnamectl nicht unterstÃ¼tzen) kann man den Hostnamen in der Datei =/etc/hostname= eintragen, z.Â B.:

#+begin_src bash
echo "clone" | sudo tee /etc/hostname
#+end_src

#+begin_quote
- =| sudo tee= :: schreibt die Ausgabe des vorangehenden Befehl mit Super-User-Rechten und die folgende Datei und gibt sie gleichzeitig in der Shell aus.
#+end_quote

* SSH-Anmeldung per Passwort zulassen

FÃ¼r den Klon soll ein eigener SchlÃ¼ssel installiert werden. Damit dieser Ã¼bertragen werden kann, muss zunÃ¤chst die Anmeldung per Passwort vorÃ¼bergehend erlaubt werden.

DafÃ¼r mÃ¼ssen einige EintrÃ¤ge in der Datei =/etc/ssh/sshd_config= geÃ¤ndert werden. DafÃ¼r kÃ¶nnen Sie z.Â B. =sed= nutzen:

#+BEGIN_SRC bash
sudo sed -E 's/^(StrictModes|Max|PubkeyAuth)/# \1/;/^#?(PasswordAuthentication)/{s/^#//;s/no/yes/}' /etc/ssh/sshd_config -i
#+END_SRC

- =-E= :: Aktiviert erweiterte regulÃ¤re AusdrÃ¼cke (ERE), wodurch z.Â B. () und {} verwendet werden kÃ¶nnen.
- =s/^(StrictModes|Max|PubkeyAuth)/# \1/= :: Findet Zeilen, die mit StrictModes oder Max beginnen und kommentiert diese mit =#= aus. =\1= wird durch =StrictModes=, =Max= oder (=|=) =PubkeyAuth= ersetztÂ â€” je nachdem was in dieser Zeile gefunden wurde.
- =/^#?(PasswordAuthentication)/{s/^#//;s/no/yes/}= :: Findet Zeilen, die =PasswordAuthentication= enthalten, unabhÃ¤ngig davon, ob sie auskommentiert sind oder nicht.
  - Entfernt ein eventuell vorhandenes =#= am Anfang der Zeile (macht sie aktiv).
  - Ersetzt den Wert =no= durch =yes=, wodurch die Anmeldung per Passwort erlaubt wird.
- =-i= :: Schreibt die Ã„nderungen direkt (in place) in die Datei =/etc/ssh/sshd_config=.

Nun kÃ¶nnen Sie auf den Hosts von denen aus Sie anmelden wollen SchlÃ¼ssel erstellen und auf den Klon Ã¼bertragen. Wie das funktioniert wird in der Datei [[file:SSH-Schluesselgenerierung.pdf][SSH-Schluesselgenerierung.pdf]] beschrieben. Passen Sie dabei den Namen des SchlÃ¼ssels an (z.Â B.Â clone statt debian).
